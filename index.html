<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>melody-jsnes</title>
  <style>
    canvas {
      width: 768px;
      height: 720px;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-crisp-edges;
      image-rendering: pixelated;
    }

    * {
      margin: 0;
      padding: 0;
    }

    #content {
      margin: 0 auto;
      width: 768px;
      text-align: center;
    }

    #message {
      font-family: sans-serif;
      padding: 30px;
      font-weight: 500;
    }

    #keys {
      font-size: 14px;
      font-family: sans-serif;
      padding-bottom: 15px;
    }
  </style>
  <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
</head>

<body>

<div id="content">
  <h1 id="message">Waiting for Players</h1>
	<p id="keys">Arrow keys = joypad, X = a, Z = b, Enter = start, Ctrl = select</p>
  <div id="emulator"></div>
</div>

<script src="jsnes/lib/jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/lib/dynamicaudio-min.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/nes.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/utils.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/cpu.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/keyboard.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/mappers.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/papu.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/ppu.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/rom.js" type="text/javascript" charset="utf-8"></script>
<script src="jsnes/source/ui.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
$(function () {

var url = "ws://" + window.location.host + "/ws";
var ws = new WebSocket(url);

var screen = $("<canvas width='256' height='240'>");
var context = screen[0].getContext('2d');
var imageData = context.getImageData(0, 0, 256, 240);
$("#emulator").append(screen);

var nes = null;
var player = 0;

function clearScreen() {
  context.fillStyle = "black";
  context.fillRect(0, 0, 256, 240);
  for (var i = 3; i < imageData.data.length-3; i += 4) {
    imageData.data[i] = 0xFF;
  }
}

function createNes() {
  nes = new JSNES({});
  var firstFrame = true;
  nes.ui.writeFrame = function (buffer, prevBuffer) {
    var data = imageData.data;
    var pixel, i, j;
    var rleBlocks = [];
    var runStart = -1;
    var runColors = [];
    for (i = 0; i < 256 * 240; i++) {
      pixel = buffer[i];
      j = i * 4;
      data[j] = pixel & 0xFF;
      data[j+1] = (pixel >> 8) & 0xFF;
      data[j+2] = (pixel >> 16) & 0xFF;
      data[j+3] = 0xFF;
      if (firstFrame || pixel != prevBuffer[i]) {
        if (runStart === -1) runStart = i;
        runColors.push(pixel);
      } else if (runStart !== -1) {
        rleBlocks.push([runStart, runColors.slice()]);
        runStart = -1;
        runColors = [];
      }
      prevBuffer[i] = pixel;
    }
    if (runStart !== -1) {
      rleBlocks.push([runStart, runColors.slice()]);
    }
    context.putImageData(imageData, 0, 0);
    var totalBytes = 0;
    for (var b = 0; b < rleBlocks.length; b++) {
      totalBytes += 8 + rleBlocks[b][1].length * 3;
    }
    var buf = new ArrayBuffer(totalBytes);
    var view = new DataView(buf);
    var offset = 0;
    for (var b = 0; b < rleBlocks.length; b++) {
      var start = rleBlocks[b][0];
      var colors = rleBlocks[b][1];
      view.setUint32(offset, start, true); offset += 4;
      view.setUint32(offset, colors.length, true); offset += 4;
      for (var c = 0; c < colors.length; c++) {
        var p = colors[c];
        view.setUint8(offset++, p & 0xFF);
        view.setUint8(offset++, (p >> 8) & 0xFF);
        view.setUint8(offset++, (p >> 16) & 0xFF);
      }
    }
    if (player === 1 && totalBytes > 0) {
      var compressed = pako.deflate(new Uint8Array(buf));
      ws.send(compressed.buffer);
    }
    firstFrame = false;
  };
}

function loadROM(url) {
  $.ajax({
    url: escape(url),
    xhr: function() {
      var xhr = $.ajaxSettings.xhr();
      xhr.overrideMimeType('text/plain; charset=x-user-defined');
      return xhr;
    },
    complete: function(xhr, status) {
      nes.loadRom(xhr.responseText);
      nes.start();
    }
  });
}

function triggerKey(type, keyCode) {
  var e = jQuery.Event(type);
  e.which = keyCode;
  e.keyCode = keyCode;
  $(document).trigger(e);
}

function sendKey(type, keyCode) {
  ws.send(type + " " + keyCode);
}

function sendScreen(buffer) {
  screen[0].toBlob(function (blob) {
    ws.send(blob);
  });
}

function drawData(data) {
  var img = new Image();
  img.src = data;
  img.onload = function () {
    context.clearRect(0, 0, screen.width, screen.height);
    context.drawImage(img, 0, 0);
  };
}

function startPlaying(data) {
	player = parseInt(data, 10);

  if (player == 1) {
    newGame();
		$("#message").text("You are Player 1");
  }
  if (player == 2) {
    $("#message").text("You are Player 2");
  }

  if (player == 3) {
    $("#message").text("You are Player 3");
  }

  if (player == 4) {
    $("#message").text("You are Player 4");
  }
}

function newGame() {
	if(player == 1) {
		clearScreen();
  	createNes();
  	loadROM("/rom");
	}
}

function stopPlaying() {
  if (nes !== null) {
    nes.stop();
    nes = null;
  }
  clearScreen();
  player = 0;
  $("#message").text("Waiting for Players");
}

function applyRLE_RGB_DiffBuffer(buf) {
  var u8 = new Uint8Array(buf);
  var view = new DataView(buf);
  var data = imageData.data;
  var idx = 0;
  while (idx + 8 <= u8.length) {
    var start = view.getUint32(idx, true); idx += 4;
    var len = view.getUint32(idx, true); idx += 4;
    if (len === 0 || idx + len*3 > u8.length) break;
    for (var k = 0; k < len; k++) {
      var r = u8[idx++];
      var g = u8[idx++];
      var b = u8[idx++];
      var i = start + k;
      var j = i * 4;
      data[j] = r;
      data[j + 1] = g;
      data[j + 2] = b;
      data[j + 3] = 0xFF;
    }
  }
  context.putImageData(imageData, 0, 0);
}

ws.onmessage = function (msg) {
  if (msg.data instanceof Blob) {
    msg.data.arrayBuffer().then(function(buf) {
      var decompressed = pako.inflate(new Uint8Array(buf)).buffer;
      applyRLE_RGB_DiffBuffer(decompressed);
    });
  } else {
    var parts = msg.data.split(" ");
    var cmd = parts[0];
    var data = parts[1];

    if (cmd === "join") {
      startPlaying(data);
    }

    if (cmd === "part") {
      stopPlaying();
    }

    if (cmd === "keyup" || cmd === "keydown") {
      triggerKey(cmd, parseInt(data, 10));
    }
  }
};

var keyMap = {
  88: 2103,
  90: 2105,
  17: 299,
  13: 297,
  38: 2104,
  40: 298,
  37: 2100,
  39: 2102
};

var keyMap3 = {
  88: 316,
  90: 318,
  17: 381,
  13: 369,
  38: 387,
  40: 383,
  37: 365,
  39: 368
};

var keyMap4 = {
  88: 416,
  90: 419,
  17: 485,
  13: 479,
  38: 473,
  40: 475,
  37: 474,
  39: 476
};

$(document).bind("keydown", function(evt) {
  var code = evt.keyCode;
  if (player == 1) { nes.keyboard.keyDown(evt); }
  if (player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keydown", keyMap[code]); }
  if (player == 3 && keyMap3[code]) { evt.preventDefault(); sendKey("keydown", keyMap3[code]); }
  if (player == 4 && keyMap4[code]) { evt.preventDefault(); sendKey("keydown", keyMap4[code]); }
});

$(document).bind("keyup", function(evt) {
  var code = evt.keyCode;
  if (player == 1) { nes.keyboard.keyUp(evt); }
  if (player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keyup", keyMap[code]); }
  if (player == 3 && keyMap3[code]) { evt.preventDefault(); sendKey("keyup", keyMap3[code]); }
  if (player == 4 && keyMap4[code]) { evt.preventDefault(); sendKey("keyup", keyMap4[code]); }
});

clearScreen();

});
</script>
</body>
</html>
